# 更新日志

所有重要的版本更新都会记录在此文件中。

## [1.1.0] - 2024-11-13

### ⚠️ 重要架构更新
- **重构 AI 工具架构，解决控制权移交问题**
  - 原架构：AI工具返回llm
  - 新架构：AI工具直接调用主插件方法，由主插件完成所有操作
  - 修改内容：
    - 新增 `ai_start_game()`、`ai_join_game()`、`ai_check_status()` 供AI工具调用
    - 简化AI工具逻辑，移除游戏状态处理代码

### 🐛 修复
- **修复 AI 工具无法访问游戏状态的问题**
  - 修复 `join_revolver_game` 工具错误访问 `self.group_games` 而不是 `self.plugin.group_games`
  - 修复 `check_revolver_status` 工具错误访问 `self.group_games` 而不是 `self.plugin.group_games`
  - 这两个 bug 导致 AI 无法正确检测进行中的游戏，总是返回"没有游戏进行中"

- **修复 AI 工具缺少超时机制的问题**
  - `start_revolver_game` 工具现在会正确调用 `_start_timeout` 启动超时机制
  - 与主插件的 `/装填` 命令保持一致的行为

- **修复 AI 工具游戏结束清理不完整的问题**
  - `join_revolver_game` 工具在游戏结束时现在会正确清理超时任务
  - 添加 `timeout_tasks.pop(group_id, None)` 确保资源完全释放
  - 与主插件的 `/开枪` 命令保持一致的行为

- **改进空值安全性**
  - 在访问 `self.plugin` 前添加空值检查，防止潜在的 NoneType 错误

### 🎯 改进
- **增强工具描述清晰度**
  - 优化 `start_revolver_game` 工具的描述，明确包含"我也要玩"等常见表达
  - 优化 `join_revolver_game` 工具的描述，强调"仅在游戏进行中时使用"
  - 帮助 AI 更准确地区分何时开始新游戏，何时参与现有游戏

- **为 AI 工具添加参数支持**
  - `join_revolver_game` 工具新增 `action` 参数，支持 shooting/joining/participating 等动作
  - `check_revolver_status` 工具新增 `detailed` 参数，支持返回详细游戏状态
  - 让 AI 能够更精确地控制工具行为和输出

- **优化 AI 输出指令**
  - 在所有 AI 工具描述中添加关键指令
  - 明确要求 AI 直接输出工具结果，禁止修改、重写或添加个人评论
  - 解决 AI 添加冗余文本（如"根据查询"、"我来告诉你"）的问题，确保输出与游戏模板一致

- **添加自定义游戏文本配置支持**
  - 在 `_conf_schema.json` 中添加 10 个文本类别配置选项
  - 支持通过 WebUI 自定义所有游戏文本（走火描述、用户反应、空弹消息等）
  - 优先使用配置中的自定义文本，未配置时使用默认 YAML 文件
  - 让管理员可以根据群组风格自定义游戏文案

### 🛡️ 技术优化
- **移除冗余文件**
  - 删除 `metadata.py`（AstrBot 不需要）
  - 简化 `__init__.py` 为最小格式
  - 插件元数据内联到 `@register` 装饰器
- **改进文本管理器**
  - 重构 `TextManager` 初始化逻辑，在加载时决定数据源
  - 避免每次调用 `get_text()` 时的重复判断
  - 支持从配置文件或 YAML 文件加载文本
- **优化 AI 工具消息发送机制**
  - AI 工具现在直接通过 `event.bot.send_group_msg` 向群聊发送消息。
  - 解决了 LLM 冗余回复的问题，确保用户反馈由插件直接控制。

### ⚡ 影响范围
- 修复了用户通过自然语言（如"我也要玩"）参与游戏时失败的问题
- 修复了 AI 查询游戏状态返回错误信息的问题
- 现在 AI 工具与指令功能的行为完全一致

## [1.0.0] - 2024-11-12

### ✨ 新增
- **基于 AstrBot 官方规范全新开发**
  - 严格遵循 AstrBot v4.5.0+ 插件开发规范
  - 使用现代化的类型注解和异步编程
  
- **AI 自然语言交互支持**
  - 支持通过自然语言开启游戏（"来玩左轮手枪"）
  - 支持通过自然语言参与游戏（"我也要玩"、"开枪"）
  - 支持通过自然语言查询状态（"游戏状态"、"现在什么情况"）
  
- **指令系统优化**
  - 使用指令组结构（`左轮 状态`、`左轮 帮助`）避免指令冲突
  - 独立指令（`/装填`、`/开枪`）便于快速操作
  
- **权限控制系统**
  - 管理员可指定子弹数量（`/装填 3`）
  - 管理员可控制随机走火功能（`/走火开`、`/走火关`）
  - 普通用户只能使用随机装填（`/装填`）
  
- **随机机制**
  - 随机装填 1-6 发子弹
  - 随机走火概率（默认 0.3%）
  - 随机禁言时长（60-300 秒）
  
- **超时机制**
  - 游戏装填后 120 秒内无操作自动结束
  - 自动清理游戏状态，防止资源泄漏
  
- **数据持久化**
  - 走火配置自动保存到 `group_misfire.json`
  - 重启插件后保留各群的走火设置
  
- **管理员免疫机制**
  - 群主和管理员中弹后不会被禁言
  - 显示免疫提示，避免误禁言

### 🛡️ 技术特性
- **类型注解**：完整的类型提示，提高代码可维护性
- **异步编程**：全异步处理，性能优异
- **错误处理**：完善的异常捕获和日志记录
- **模块化设计**：功能分离，易于扩展
- **内存安全**：自动资源清理机制
- **健壮性**：改进的状态共享机制
- **一致性**：AI 工具与指令功能统一

### 📱 文本风格
- 采用简洁有力的现代文本风格
- 使用 emoji 增强视觉效果
- 清晰的提示信息，便于用户理解

---

## 版本命名规则

- **主版本号（Major）**：重大功能更新或不兼容的 API 更改
- **次版本号（Minor）**：新增功能，向下兼容
- **修订号（Patch）**：Bug 修复，向下兼容

## 更新建议

- **补丁版本（如 1.0.0 → 1.0.1）**：可直接更新，无兼容性问题
- **次版本更新（如 1.0.x → 1.1.0）**：可直接更新，新增功能可选使用
- **主版本更新（如 1.x.x → 2.0.0）**：请查看更新日志中的破坏性变更

---

**查看 GitHub Releases 获取更详细的更新信息：**
https://github.com/piexian/astrbot_plugin_rg2/releases
