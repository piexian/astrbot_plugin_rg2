# 🔫 左轮手枪对决

基于 AstrBot 官方插件规范开发的群聊轮盘赌游戏插件，采用现代化代码架构，提供刺激的左轮手枪对决体验。

[![AstrBot Plugin](https://img.shields.io/badge/AstrBot-Plugin-blue.svg)](https://docs.astrbot.app/)
[![Version](https://img.shields.io/badge/version-1.0.0-green.svg)](https://github.com/piexian/astrbot_plugin_rg)
[![Python](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/)

## ✨ 核心特性

- **🎯 规范开发**：严格遵循AstrBot官方插件开发规范
- **🤖 AI交互**：支持自然语言开启游戏、参与对决、查询状态
- **⚡ 指令优化**：使用指令组结构，逻辑清晰
- **🔒 权限控制**：管理员专用功能，安全可靠
- **🎲 随机机制**：随机装填、随机走火、随机惩罚
- **⏰ 超时机制**：自动结束闲置游戏（120秒超时）
- **🛡️ 错误处理**：完善的异常捕获和日志记录
- **📊 状态管理**：高效的并发游戏状态管理

## 🚀 快速开始

### 安装要求
- AstrBot v4.5.0+
- Python 3.10+

### 安装插件

#### 方法一：插件市场（推荐）
在 AstrBot WebUI 的插件市场中搜索 **"左轮手枪对决"** 或 **"astrbot_plugin_rg2"**，点击安装即可。

#### 方法二：Git 克隆
1. 克隆插件到 AstrBot 插件目录
```bash
cd AstrBot/data/plugins
git clone https://github.com/piexian/astrbot_plugin_rg2
```
2. 在 WebUI 中启用插件
3. 配置插件参数（可选）
4. 确保机器人有群管理权限

### 基础使用

#### 独立指令（最常用）
```bash
# 装填子弹（随机1-6发，所有人可用）
[指令前缀]装填

# 装填子弹（指定数量，1-6发，仅限管理员）
[指令前缀]装填 3

# 参与游戏，扣动扳机
[指令前缀]开枪

# 开启随机走火功能（仅限管理员）
[指令前缀]走火开

# 关闭随机走火功能（仅限管理员）
[指令前缀]走火关
```

#### 指令组指令（避免冲突）
```bash
# 查看当前游戏状态
[指令前缀]左轮 状态

# 显示帮助信息
[指令前缀]左轮 帮助
```

**注意**：`[指令前缀]`默认为`/`，可在AstrBot配置中修改。`状态`和`帮助`指令放入了`左轮`指令组，避免与其他插件冲突。如果输入`[指令前缀]左轮`会显示指令组的树形结构。

#### 用户指令
```bash
# 参与游戏，扣动扳机
[指令前缀]开枪

# 查看当前游戏状态
[指令前缀]左轮 状态

# 显示帮助信息
[指令前缀]左轮 帮助
```

## 🎮 游戏功能

### 管理员专属功能
- **装填子弹（指定数量）**：`[指令前缀]装填 [数量]` - 指定1-6发子弹，仅限管理员
- **走火控制**：`[指令前缀]走火开` 或 `[指令前缀]走火关` - 控制随机走火功能，仅限管理员

### 所有用户可用功能
- **装填子弹（随机）**：`[指令前缀]装填` - 随机装填1-6发子弹，所有人可用
- **参与游戏**：`[指令前缀]开枪` - 扣动扳机参与游戏
- **查询状态**：`[指令前缀]左轮 状态` - 查看当前游戏状态（剩余子弹、当前弹膛）
- **查看帮助**：`[指令前缀]左轮 帮助` - 显示完整的使用说明和游戏规则

### AI自然语言交互
- **开启游戏**："我们来玩左轮手枪吧"、"再来一局"
- **参与游戏**："我也要玩"、"开枪"
- **查询状态**："游戏状态"、"现在什么情况"

**提示**：AI功能需要在AstrBot中启用AI对话功能才能使用。

### 用户功能
- **射击**：`[指令前缀]开枪` - 扣动扳机参与游戏
- **状态查询**：`[指令前缀]左轮 状态` - 查看当前游戏状态（剩余子弹、当前弹膛）
- **帮助**：`[指令前缀]左轮 帮助` - 显示完整的使用说明和游戏规则

### AI自然语言交互
AI会自动识别以下意图并执行相应操作：

- **开启游戏**：
  - "我们来玩左轮手枪吧"
  - "来玩轮盘赌"
  - "再来一局"（play again）
  
- **参与游戏**：
  - "我也要玩"
  - "我也要参加"
  - "开枪"
  - "shoot"
  
- **查询状态**：
  - "游戏情况如何"
  - "状态"
  - "status"
  - "现在什么情况"

AI功能需要在AstrBot中启用AI对话功能才能使用。

## ⚙️ 配置说明

插件支持可视化配置，可在 AstrBot 管理面板调整：

| 配置项 | 说明 | 默认值 | 建议范围 |
|--------|------|--------|----------|
| `timeout_seconds` | 游戏超时时间（秒） | 120 | 60-300 |
| `misfire_probability` | 随机走火概率（0.0-1.0） | 0.003 | 0-0.01 |
| `min_ban_seconds` | 最小禁言时长（秒） | 60 | 30-120 |
| `max_ban_seconds` | 最大禁言时长（秒） | 300 | 120-600 |
| `misfire_enabled_by_default` | 新群默认开启走火 | false | true/false |

## 🎯 游戏规则

1. **弹膛设置**：6个弹膛，随机装填实弹
2. **射击机制**：轮流扣动扳机，空弹继续，实弹禁言
3. **惩罚机制**：中弹后随机禁言60-300秒
4. **超时机制**：装填后120秒内无操作自动结束
5. **随机走火**：群聊消息有0.3%概率触发走火（如开启）
6. **数据持久化**：走火配置自动保存，重启后保留

## 🔧 技术特性

### 代码规范
- **类型注解**: 完整的类型提示
- **异步编程**: 全异步处理，性能优异
- **错误处理**: 完善的异常捕获机制
- **日志记录**: 详细的操作日志
- **文档规范**: 标准化的docstring注释

### 架构设计
- **模块化**: 功能分离，易于维护
- **可扩展**: 支持功能扩展和定制
- **高性能**: 高效的状态管理
- **内存安全**: 自动资源清理
- **数据持久化**: 配置自动保存和加载

## 🤖 AI功能详情

### 函数工具
1. **`start_revolver_game`** - 智能开启游戏
   - 理解自然语言意图（"来玩左轮手枪"、"再来一局"）
   - 支持指定子弹数量
   - 自动初始化游戏状态
   - 设置超时机制

2. **`join_revolver_game`** - 智能参与游戏
   - 执行射击逻辑（"我要玩"、"开枪"）
   - 处理游戏结果
   - 执行禁言惩罚
   - 管理状态更新

3. **`check_revolver_status`** - 智能查询状态
   - 显示游戏状态（"状态"、"游戏情况"）
   - 提供安全提示
   - 实时子弹信息

### 使用示例
```
用户：我们来玩左轮手枪吧！
AI：🎯 用户名称 挑战命运！
    🔫 装填 4 发子弹！
    💀 谁敢扣动扳机？

用户：我也要玩！
AI：🎲 用户名称 逃过一劫！

用户：现在情况怎么样？
AI：🔫 游戏进行中
    📊 剩余：3发子弹
    🎯 第2膛
    🍀 安全

用户：再来一局！
AI：🎯 用户名称 挑战命运！
    🔫 装填 2 发子弹！
    💀 谁敢扣动扳机？
```

## 📱 文本风格

采用简洁有力的现代文本风格：

- **装填**："🔫 用户名称 装填 3 发子弹！"
- **空弹**："🎲 咔哒！用户名称 逃过一劫！"
- **中弹**："💥 枪声炸响！用户名称 中弹倒地！"
- **走火**："💥 砰！手枪走火！用户名称 不幸中弹！"

## 🔧 技术特性

- **现代Python**：使用类型注解、异步编程
- **模块化设计**：功能分离，易于维护
- **错误处理**：完善的异常捕获机制
- **性能优化**：高效的状态管理
- **内存安全**：自动清理机制
- **数据持久化**：JSON配置自动保存
- **健壮性**：改进的状态共享机制
- **一致性**：AI工具与指令功能统一

## 🔄 版本历史

### v1.0.0 (2024-11-12)
- ✨ 基于AstrBot官方规范全新开发
- 🤖 AI自然语言交互支持
- ⚡ 优化的指令组结构
- 🔒 完善的权限控制
- 🎲 增强的随机机制
- 📱 现代化文本风格
- 🛡️ 完善的错误处理
- 📊 高效的状态管理
- 💾 数据持久化功能
- ⏰ 完善的超时机制
- 🔧 改进的状态共享机制
- ⚖️ AI工具与指令功能统一

## ⚠️ 注意事项

1. **权限要求**：需要管理员权限才能使用 `/装填`、`/走火开`、`/走火关` 指令
2. **群聊专用**：所有功能仅在群聊中可用，私聊无效
3. **禁言功能**：确保机器人有群管理权限，否则禁言会失败
4. **AI支持**：需要在AstrBot中启用AI对话功能才能使用自然语言交互
5. **游戏状态**：同一时间一个群只能进行一个游戏
6. **超时机制**：游戏装填后120秒内无人操作会自动结束
7. **数据持久化**：走火配置会自动保存，重启插件后保留设置
8. **管理员免疫**：群主和管理员中弹后不会被禁言（显示免疫提示）

## 🐛 故障排除

**游戏无法开始？**
- 检查是否有管理员权限
- 确认在群聊中使用
- 查看是否有进行中的游戏

**AI功能不工作？**
- 确保启用了AI对话功能
- 检查函数工具是否加载成功
- 确认自然语言意图清晰

**禁言失败？**
- 检查机器人群管理权限
- 确认目标用户可禁言
- 查看日志获取详细错误

## 📞 支持

如有问题请访问 [GitHub仓库](https://github.com/piexian/astrbot_plugin_rg2/issues) 提交issue。

## 🙏 致谢

本项目基于 **[astrbot_plugin_rg](https://github.com/zgojin/astrbot_plugin_rg)** 进行修改和优化，感谢原作者 [zgojin](https://github.com/zgojin) 的开源贡献！

**🔫 准备好了吗？来一局刺激的左轮手枪对决吧！**
